---
title: G1垃圾回收器
category:
  - Java
order: 100
tag:
  - Java基础
  - JDK
  - G1
---

## G1 垃圾回收器简介

G1（Garbage First）垃圾回收器是Java HotSpot虚拟机中的一种高性能垃圾回收器，设计用于处理大规模内存管理需求，特别是对低延迟和高吞吐量有严格要求的应用程序。G1 垃圾回收器能够在提供良好响应时间的同时，确保高效的内存管理。

### 1. 设计目标
- 低延迟：旨在减少垃圾回收对应用程序的停顿时间。
- 高吞吐量：尽量减少应用程序的中断，从而提高整体吞吐量。
- 可预测性：提供可配置的暂停时间目标，便于预测应用程序性能。

### 2. 适用场景
- 大型堆内存：适合多GB甚至数十GB的大堆内存。
- 低延迟要求：特别适用于需要低延迟和可预测的应用程序，例如实时系统、在线服务等。
- 动态对象分配：适合频繁对象创建和销毁的场景。

### 3. 基本工作原理
G1 垃圾回收器将堆划分为多个大小相等的区域（region），每个区域可以包含不同类型的对象：新生代（Young Generation）和老年代（Old Generation）对象。  
G1 根据区域的垃圾比例，优先回收垃圾最多的区域，从而优化内存回收的效率。

## G1 垃圾回收器的主要特点

### 1. 区域划分
- 区域大小：堆被划分成若干大小相等的区域，每个区域大小通常在1MB到32MB之间。
- 多种区域类型：包括 Eden 区（新生代）、Survivor 区（存活区）、Old 区（老年代）、Humongous 区（超大对象区）。

### 2. 增量压缩
- 混合回收：G1 通过增量式的方式进行垃圾回收，即在一次回收过程中，不仅回收新生代，还会回收部分老年代。
- 增量整理：G1 垃圾回收器在进行垃圾回收时，会对部分区域进行整理，释放出连续的可用内存空间。

### 3. 并行与并发回收
- 并行回收：G1 垃圾回收器可以使用多核 CPU 来并行执行垃圾回收任务，从而减少回收时间。
- 并发回收：在垃圾回收期间，应用程序可以继续执行，从而减少了应用程序停顿时间。

### 4. 可预测的停顿时间
- 停顿时间控制：G1 允许用户设定最大停顿时间目标（例如，200毫秒），以便根据应用程序需求进行调优。
- 停顿时间预测：G1 会根据历史垃圾回收数据，动态调整回收行为，以尽量满足设定的停顿时间目标。

### 5. 分阶段回收
- 初始标记：快速标记活跃对象的根集。
- 并发标记：并发标记所有活动对象，以便识别需要回收的对象。
- 最终标记：完成对活跃对象的标记，并重新标记从根到活动对象的路径。
- 回收清理：对被标记为垃圾的区域进行回收和整理。

## G1 的工作流程

### 1. 新生代垃圾回收（Young GC）
- Eden 区满时触发：当 Eden 区满时，触发新生代垃圾回收。
- 对象晋升：在新生代垃圾回收时，存活的对象会移动到 Survivor 区，若 Survivor 区满，老年代会接收部分对象。

### 2. 混合垃圾回收（Mixed GC）
- 部分老年代回收：除了回收新生代对象，还会回收部分老年代对象。
- 选择性回收：G1 根据区域的垃圾百分比和停顿时间目标，选择性地回收部分老年代区域。

### 3. 完全垃圾回收（Full GC）
- 老年代满时触发：当老年代满时，触发完全垃圾回收。
- 全堆回收：对整个堆进行垃圾回收，通常是 stop-the-world 操作，应用程序暂停。

## G1 垃圾回收器的优势

- 低停顿时间：通过增量回收和并发执行，减少应用程序的停顿时间。
- 高可预测性：提供可配置的停顿时间目标，便于调优和预测性能。
- 适合大堆内存：能够高效管理多GB甚至数十GB的堆内存。
- 灵活性：支持多种不同类型的对象分配和回收策略，适应各种应用场景。

## G1 垃圾回收器的调优

### 1. 设定停顿时间目标
- 使用 `-XX:MaxGCPauseMillis=<N>` 来设定最大停顿时间，例如：
  ```bash
  -XX:MaxGCPauseMillis=200
  ```

### 2. 调整并发线程
- 使用 `-XX:ParallelGCThreads=<N>` 和 `-XX:ConcGCThreads=<N>` 来调整并发和并行线程的数量。

### 3. 监控和分析
- 使用 `-XX:+PrintGCDetails` 和 `-XX:+PrintGCApplicationStoppedTime` 等选项监控垃圾回收过程，以便进行分析和调优。

## 示例配置

以下是一个典型的 G1 垃圾回收器配置示例：
```bash
-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:InitiatingHeapOccupancyPercent=45 -XX:G1ReservePercent=10
```

- `-XX:+UseG1GC`：启用 G1 垃圾回收器。
- `-XX:MaxGCPauseMillis=200`：设置最大 GC 停顿时间为 200 毫秒。
- `-XX:InitiatingHeapOccupancyPercent=45`：设置堆使用率达到 45% 时触发混合垃圾回收。
- `-XX:G1ReservePercent=10`：设置保留内存百分比，用于临时分配和减少频繁的 Full GC。

## 总结
G1 垃圾回收器通过灵活的内存管理和高效的垃圾回收机制，为 Java 应用程序提供了低停顿时间和高吞吐量的性能保证。其设计适用于大型堆内存管理和低延迟应用场景。