---
title: 降级熔断
category:
  - 高可用
order: 2
tag:
  - 服务高可用
  - 降级熔断
---

## 降级和熔断介绍
降级和熔断是微服务架构中常用的两种容错机制，用于处理服务不可用或异常情况，保障系统的稳定性和可用性。它们可以在客户端或服务端实现，帮助系统在面对异常情况时保持可用状态。

### 1. 降级（Degradation）
降级是指在系统负载过高或者出现故障时，临时关闭部分功能或者服务，以保证核心功能的正常运行。降级的目的是通过舍弃非核心功能来保障系统的稳定性，防止系统崩溃或无法响应。降级通常在以下情况下发生：
- 高负载情况：当系统负载过高时，为避免系统崩溃，可以关闭部分不太重要的功能。
- 服务异常：当某个服务出现故障或延迟过高时，可以关闭对该服务的请求，而不影响其他功能的正常运行。

### 2. 熔断（Circuit Breaking）
熔断是一种更加智能和主动的容错机制，用于防止故障的蔓延和雪崩效应。熔断器会监控对服务的调用情况，当服务出现故障或延迟超过阈值时，熔断器会临时断开对该服务的调用，转而直接返回预先设定的错误响应，避免对故障的服务继续发起请求，以免造成更严重的问题。   

熔断的主要思想是通过快速失败来迅速恢复正常状态，而不是一直等待服务恢复或超时，从而提高系统的容错能力和可用性。

### 降级与熔断的区别
- 触发时机：降级是在系统压力过大或者服务不可用时主动关闭部分功能；熔断是在服务异常或延迟超过阈值时主动断开对服务的调用。
- 处理方式：降级是关闭部分功能或服务，让系统保持稳定；熔断是临时断开对故障服务的调用，防止故障的蔓延。
- 影响范围：降级是针对非核心功能或服务的关闭；熔断是针对特定服务的调用中断。
- 时效性：降级通常是持续性的，直到系统负载降低或者服务恢复正常；熔断是临时性的，一段时间后会尝试重新连接服务。

### 实现方式
- 客户端熔断器：在客户端实现熔断逻辑，如 Hystrix 熔断器。
- 服务端熔断器：在服务端实现熔断逻辑，如 Istio 的 Envoy Sidecar Proxy。
- 手动熔断：通过监控服务状态和负载情况，手动触发熔断操作。

降级和熔断是微服务架构中常用的容错机制，它们可以有效地保障系统的稳定性和可用性，提高系统的容错能力。通过合理地使用降级和熔断机制，可以使系统在面对异常情况时依然能够提供稳定的服务。

## 服务降级
当系统面临负载过高、资源不足或者部分服务不可用等情况时，临时关闭部分功能或者服务，以保障系统的核心功能的正常运行。  
降级的目的是在面对异常情况时，通过舍弃非核心功能来降低系统的负载，保证核心功能的可用性和稳定性。  
**原因**：服务整体负荷超出整体承受能力  
**目的**：保证核心或基本服务的正常运行  
**粒度**：考虑整体模块粒度的大小，将粒度控制在合适的范围内  
**可控**：在服务粒度大小的基础上增加服务的可控性，后台服务的开关的功能是一项必要配置  
**次序**：一般从外围延伸服务开始降级，需要有一定的配置项，重要性低的优先降级，比如可以分组设置等级1-10，当服务需要降级到某一个级别时，进行相关配置  

### 常见的服务降级方式以及特点
- **关闭非关键服务**：暂时关闭一些非核心或不重要的服务，以减轻系统负载。
- **简化处理逻辑**：简化某些功能的处理逻辑，减少计算量和资源消耗。
- **限制访问频率**：限制某些功能的访问频率，减少对资源的占用。
- **展示静态页面**：当系统负载过高时，可以展示一些静态页面或者简化的页面，减少服务器的计算压力。
- **隐藏部分功能**：隐藏一些复杂或者不必要的功能，提供基本的功能服务。
- **减少数据量**：减少返回给用户的数据量，只返回必要的信息。
- **缓存数据**：提前缓存一部分数据，减少数据库的查询压力。
- **设计容灾页面**：针对核心功能设计容灾页面，当系统负载过高或者出现故障时，展示容灾页面给用户。
- **自动触发降级**：通过自动化系统，在监控到异常情况时自动触发降级策略，提高系统的响应速度和稳定性。
- **自动恢复**：在异常情况解决后，自动取消降级，恢复系统正常运行状态。

### 自动降级
- **阈值触发**：当系统负载超过预先设定的阈值时，自动触发降级策略。例如，CPU 使用率、内存使用率、请求处理时长等指标超过阈值时，自动降级。
- **请求处理能力**：根据系统的请求处理能力自动触发降级策略。例如，请求队列长度过长、请求处理速度过慢等情况下，自动降级。
- **故障率监控**：监控各个服务的故障率，当某个服务的故障率超过阈值时，自动触发降级策略，关闭对该服务的请求。
- **响应时长监控**：监控各个服务的响应时长，当某个服务的响应时长超过阈值时，自动触发降级策略，限制对该服务的请求。

### 自动降级实现
- **监控系统设计**：设计自动化监控系统，定期收集系统负载情况、服务健康状态等指标，以便自动触发降级策略。
- **规则配置**：通过规则引擎配置降级规则，根据规则匹配自动触发降级策略。例如，使用 Drools 等规则引擎。
- **自动化脚本编写**：编写自动化脚本，监控系统状态，并根据设定的条件自动触发降级操作。例如，使用 Shell 脚本、Python 脚本等。
- **容器自动化**：在容器编排工具中配置降级策略，根据系统负载情况自动调整容器的数量和资源配额。例如，使用 Kubernetes 的水平扩展功能。
- **服务网格控制**：在服务网格中配置降级策略，根据服务的健康状态和负载情况自动触发降级操作。例如，使用 Istio 的流量管理功能。

自动化降级是提高系统稳定性和可用性的重要手段之一，可以根据系统的实际情况和业务需求选择合适的自动化降级策略和实现方式。在设计和实现自动化降级系统时，需要考虑系统的复杂性、性能要求和容错需求，确保降级策略的准确性和有效性。


## 服务熔断
服务熔断是一种用于提高系统稳定性和可用性的容错机制，主要用于防止故障的蔓延和雪崩效应。  
熔断器会监控对服务的调用情况，当服务出现故障或延迟超过阈值时，熔断器会临时断开对该服务的调用，转而直接返回预先设定的错误响应，避免对故障的服务继续发起请求，以免造成更严重的问题。  


熔断的作用总结有：
1. 避免故障蔓延：熔断可以防止故障的蔓延，避免一个故障的服务对系统的其他部分造成影响。
2. 降低系统压力：熔断可以减少对故障服务的请求，从而减轻系统的压力，提高系统的可用性和稳定性。
3. 快速失败：熔断可以快速失败，避免等待超时或者无限期等待服务响应，提高系统的响应速度。


正常来说一个熔断器有一下三个状态：  
- 关闭状态：初始状态，所有请求都会正常发起。
- 打开状态：当服务出现故障或延迟超过阈值时，熔断器进入打开状态，直接返回错误响应，不再发起对服务的请求。
- 半开状态：一定时间后，熔断器会尝试恢复对服务的调用，如果服务正常，则关闭熔断，否则继续保持打开状态。

### 熔断的原理
1. 故障监控：熔断器会监控对服务的调用情况，包括请求成功率、响应时间等指标。
2. 阈值设定：设定阈值，当服务出现故障或者延迟超过阈值时，触发熔断。
3. 断开服务调用：一旦触发熔断，熔断器会临时断开对服务的调用，将请求直接返回给调用方，不再发起对故障服务的请求。
4. 定时重试：在一定时间内定时重试对服务的调用，如果服务恢复正常，则关闭熔断，否则继续保持熔断状态。


### 熔断常见的实现方式
- 客户端熔断器：在客户端实现熔断逻辑，如 Netflix 的 Hystrix 和 阿里的 Sentinel。
- 服务端熔断器：在服务端实现熔断逻辑，如 Istio 的 Envoy Sidecar Proxy。
- 手动熔断：通过手动配置熔断策略，在服务出现故障时手动触发熔断。

### 适用场景
- **依赖外部服务**：当系统依赖外部服务时，熔断可以保护系统免受外部服务不稳定性的影响。
- **微服务架构**：在微服务架构中，熔断可以避免一个微服务的故障影响整个系统的稳定性。

服务熔断是保障系统稳定性和可用性的重要手段之一，通过及时断开对故障服务的调用，避免故障的蔓延和雪崩效应，提高系统的容错能力和稳定性。


