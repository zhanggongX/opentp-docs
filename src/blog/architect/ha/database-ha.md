---
title: 数据库高性能
category:
  - 高可用
order: 5
tag:
  - 服务高可用
  - 读写分离
  - 分库分表
  - 冷热数据
---

## 数据库高可用
> 主要是适合 MySQL 数据库的一些高可用方案。
比较常见的手段有：
1. 读写分离
2. 分库分表
3. 冷数据备份

## 读写分离
一般情况下，我们都会选择一主多从，也就是一台主数据库负责写，其他的从数据库负责读。  
主库和从库之间会进行数据同步，以保证从库中数据的准确性。这样的架构实现起来比较简单，并且也符合系统的写少读多的特点。  

### 如何实现读写分离
不论是使用哪一种读写分离具体的实现方案，想要实现读写分离一般包含如下几步：  
1，部署多台数据库，选择其中的一台作为主数据库，其他的一台或者多台作为从数据库。  
2，通过主从复制，保证主数据库和从数据库之间的数据是实时同步的。  
3，系统将写请求交给主数据库处理，读请求交给从数据库处理。  

### 读写分离带来的问题
#### 读写延时
1. 针对时效性要求比较严格的数据，这种方案虽然会增加主库的压力，但是，实现起来比较简单。  
比如 Sharding-JDBC 就是采用的这种方案。通过使用 Sharding-JDBC 的 HintManager 分片键值管理器，我们可以强制使用主库。  
2. 通过业务手段，写入数据库增加页面 loading 超过同步时间后即可。
3. 使用半同步复制，主库提交事务时，至少等待一个从库确认收到该事务才返回给客户端，可以缩短延迟感知，但是会带来性能问题。
#### 一致性问题
1. 使用半同步复制，主库提交事务时，至少等待一个从库确认收到该事务才返回给客户端。
2. 全同步复制，

## 分库分表
遇到下面几种场景可以考虑分库分表：
1. 单表的数据达到千万级别以上，数据库读写速度比较缓慢。
2. 数据库中的数据占用的空间越来越大，备份时间越来越长。

## 常见的分片算法
### 垂直分片（Vertical Sharding）
- 按表列进行分片，不同列存储在不同的分片中。
- 适用于将一个大的表拆分成多个子表。

优点：
- 可以减少单个表的列数量，提高查询性能。
- 适用于特定业务场景，如分离冷热数据。

缺点：    
- 查询需要跨表连接，增加复杂性。
- 数据一致性维护困难。

### 水平分片（Horizontal Sharding）
- 将表按行拆分到多个分片中，每个分片包含部分行数据。

优点：
- 提高单表的写入性能。
- 易于扩展数据库容量。

缺点：
- 查询需要跨分片时，性能可能受到影响。
- 动态扩展和数据重分配较复杂。

## 常见的水平分片算法
### 范围分片（Range Sharding）
- 根据某个列的值范围进行分片，例如按用户ID、日期等。
- 每个分片包含一定范围内的数据。

优点：
- 简单易理解。
- 适用于有明确范围的分片字段，如时间、ID。

缺点：
- 数据分布不均衡时，可能导致部分分片过大，影响性能。
- 范围查询性能较好，但点查询和写入性能可能受影响。

### 哈希分片（Hash Sharding）
- 对某个列的值进行哈希运算，然后根据哈希值进行分片。
- 哈希函数可以均匀地将数据分布到各个分片。

优点：
- 数据分布均匀，避免热点问题。
- 适用于分布式系统中需要均衡负载的场景。

缺点：
- 范围查询性能较差，需要查询多个分片。
- 动态扩展和收缩分片较复杂。

### 映射分片（Map-Based Sharding）
- 通过预定义的映射关系，将某个列的值映射到具体的分片。
- 可以使用静态配置或动态映射表来实现。

优点：
- 灵活性高，可以根据业务需求自定义分片规则。
- 适用于特殊的业务场景。

缺点：
- 需要维护映射关系，增加复杂性。
- 映射关系变化时需要进行调整。

### 按日期分片（Date Sharding）
- 根据日期时间进行分片，例如按月、按年分表。
- 每个分片存储某个时间段的数据。

优点：
- 时间序列数据查询性能好。
- 易于管理历史数据和归档。

缺点：
- 需要定期创建新的分片。
- 查询跨分片时需要多次查询。

### 复合分片（Composite Sharding）
- 结合多种分片算法，例如先按范围分片，再在每个范围内进行哈希分片。
- 适用于需要更加精细的分片控制的场景。

优点：
- 提供更好的数据均衡性和查询性能。
- 适用于复杂的业务场景。

缺点：
- 实现和维护复杂。
- 分片规则变化时调整困难。

### 一致性哈希分片（Consistent Hashing）
- 使用一致性哈希算法，将数据分配到哈希环上的节点。
- 动态增加或减少节点时，影响范围较小。

优点：
- 动态扩展和收缩分片时对已有数据影响较小。
- 适用于节点数量变化频繁的场景。

缺点：
- 实现复杂。
- 需要维护虚拟节点来提高分布均匀性。

### 地理位置分片：
很多 NewSQL 数据库都支持地理位置分片算法，也就是根据地理位置（如城市、地域）来分配数据。  

> 分库分表的分片算法有多种选择，每种算法都有其优点和缺点。选择合适的分片算法需要根据具体业务需求、数据访问模式、扩展性要求等因素进行权衡。  


## 分库分表带来的问题
1. join 操作  
同一个数据库中的表分布在了不同的数据库中，导致无法使用 join 操作。  
这样就导致我们需要手动进行数据的封装，比如你在一个数据库中查询到一个数据之后，再根据这个数据去另外一个数据库中找对应的数据。  
不过，我们日常开发中也是建议尽量不要使用 join 操作， 因为 join 的效率低，并且会对分库分表造成影响。对于需要用到 join 操作的地方，可以采用多次查询业务层进行数据组装的方法。不过，这种方法需要考虑业务上多次查询的事务性的容忍度。   
2. 事务问题  
同一个数据库中的表分布在了不同的数据库中，如果单个操作涉及到多个数据库，那么数据库自带的事务就无法满足我们的要求了。这个时候，我们就需要引入分布式事务了, 如果不是特别关键的的服务还可以使用柔性事务，如果是支付等服务还要考虑使用刚性事务，可能就需要引入第三方的中间件，第一步增加了系统的复杂性。    
3. 分布式ID  
分库分表后， 数据遍布在不同表内，数据库的自增主键已经没办法满足生成的主键唯一了。需要为使用分布式 ID，不过分布式 ID 差不多也是微服务的标配了。
4. 跨库聚合查询问题  
分库分表会导致常规聚合查询操作，如 group by，order by 等变得异常复杂。这是因为这些操作需要在多个分片上进行数据汇总和排序，而不是在单个数据库上进行。  
为了实现这些操作，需要编写复杂的业务代码，或者使用中间件来协调分片间的通信和数据传输。这样会增加开发和维护的成本，以及影响查询的性能和可扩展性。

## 数据冷热分离
数据库的冷热分离是指将数据库中访问频率不同的数据分开存储和管理的一种优化策略。通过将频繁访问的数据（热数据）和不常访问的数据（冷数据）存储在不同的存储介质或数据库系统中，可以提高数据库的整体性能和资源利用效率。  
例如：邮件系统中，可以将近期的比较重要的邮件放在收件箱，将比较久远的不太重要的邮件存入归档。

### 热数据与冷数据
- 热数据：指访问频率高、更新频繁的数据。例如，最近几个月的订单信息、活跃用户的操作记录等。
- 冷数据：指访问频率低、更新不频繁的数据。例如，历史订单、过期的日志记录等。

### 冷热分离的优势
1. 性能优化：热数据存储在高性能存储介质（如SSD）上，保证快速读写和响应时间；冷数据存储在较低性能但更经济的存储介质（如HDD）上。
2. 成本节约：通过将不常访问的数据迁移到成本较低的存储介质，可以降低存储成本。
3. 管理简化：热数据量较小，索引、备份和恢复操作更快，更容易管理。
4. 提高可扩展性：冷热分离后，可以独立扩展热数据和冷数据的存储，增强系统的扩展能力。

### 冷热分离的实现方法

1. 垂直分区：将表按照数据的访问频率进行拆分，热数据和冷数据存储在不同的表或库中。
2. 水平分区：通过时间或其他字段对表进行分区，将不同时间段的数据存储在不同的分区中。例如，按月份分区，最近的几个月数据为热数据，历史数据为冷数据。
3. 数据迁移：定期将过期的数据从热数据存储迁移到冷数据存储，可以通过 canal 等工具实现。
4. 缓存机制：将热数据缓存到内存数据库（如Redis）或缓存层中，减少对数据库的直接访问，提高访问速度。
5. 数据生命周期管理：定义数据的生命周期策略，根据数据的访问频率和重要性，自动将数据在热存储和冷存储之间迁移。

### 常见的冷热分离的架构

#### 1. 基于分区表的冷热分离
在 MySQL 中，可以使用分区表实现冷热分离。例如，将订单表按日期进行分区。  
在这种方式下，可以将历史数据的分区（如 p2022）迁移到冷存储介质，而活跃数据的分区（如 p2023）保留在热存储介质上。

#### 2. 使用不同存储系统的冷热分离
将热数据存储在高性能的关系型数据库（如 MySQL、PostgreSQL）中，冷数据存储在分布式文件系统（如 Hadoop HDFS）或NoSQL数据库（如 MongoDB、Cassandra）中。
```text
                      +-------------+
                      | Application |
                      +-------------+
                             |
                             |
                      +-------------+
                      |   Proxy     |
                      +-------------+
                       /           \
                      /             \
          +-------------+      +-------------+
          |  Hot Data   |      |  Cold Data  |
          |  MySQL      |      |  HDFS       |
          +-------------+      +-------------+
```
在这种架构下，应用通过代理层访问数据库，代理层负责根据数据的访问频率将请求路由到相应的存储系统。  

#### 3. 利用缓存层的冷热分离
将热数据缓存到内存数据库中，减少对后端数据库的访问。  

```text
+-------------+
| Application |
+-------------+
       |
       |
+-------------+
|   Cache     |
|   (Redis)   |
+-------------+
       |
       |
+-------------+
|  Database   |
|  (MySQL)    |
+-------------+
```
在这种架构下，热数据存储在 Redis 中，查询时优先从 Redis 获取，若未命中则访问 MySQL 获取数据并缓存到 Redis，这也是最最最常见的热数据方案了。  

### 实现冷热分离的注意事项
1. 数据一致性：在冷热数据迁移过程中，确保数据的一致性和完整性，避免数据丢失或重复。
2. 性能监控：实时监控冷热数据的访问频率和系统性能，及时调整冷热数据的存储策略。
3. 自动化管理：利用自动化工具和脚本，实现数据的定期迁移和存储管理，减少人工干预。
4. 安全性：确保冷热数据在不同存储介质上的安全性，防止数据泄露和损坏。

> 数据库的冷热分离是一种优化数据库性能和成本的有效策略。通过将频繁访问的热数据和不常访问的冷数据分开存储和管理，可以提高系统的性能、降低存储成本，并简化数据管理。在实际应用中，可以根据业务需求选择合适的实现方法和架构，如使用分区表、不同存储系统、缓存机制等。通过合理的冷热分离策略，能够显著提升数据库系统的整体效能。


