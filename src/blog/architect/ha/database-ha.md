---
title: 数据库高性能
category:
  - 高可用
order: 5
tag:
  - 服务高可用
  - 读写分离
  - 分库分表
  - 冷热数据
---

## 读写分离
一般情况下，我们都会选择一主多从，也就是一台主数据库负责写，其他的从数据库负责读。主库和从库之间会进行数据同步，以保证从库中数据的准确性。这样的架构实现起来比较简单，并且也符合系统的写少读多的特点。
## 如何实现读写分离
不论是使用哪一种读写分离具体的实现方案，想要实现读写分离一般包含如下几步：
1，部署多台数据库，选择其中的一台作为主数据库，其他的一台或者多台作为从数据库。
2，保证主数据库和从数据库之间的数据是实时同步的，这个过程也就是我们常说的主从复制。
3，系统将写请求交给主数据库处理，读请求交给从数据库处理。
## 主从延迟问题
1，针对时效性要求比较严格的数据，这种方案虽然会增加主库的压力，但是，实现起来比较简单
比如 Sharding-JDBC 就是采用的这种方案。通过使用 Sharding-JDBC 的 HintManager 分片键值管理器，我们可以强制使用主库。
2，延迟之后读取，你可以在完成写请求之后，避免立即进行请求操作。比如你支付成功之后，跳转到一个支付成功的页面，下单后有一个下单成功的页面，用户去点击完成，就有一个时间过程。

## 什么情况下需要分库分表
遇到下面几种场景可以考虑分库分表：
单表的数据达到千万级别以上，数据库读写速度比较缓慢。
数据库中的数据占用的空间越来越大，备份时间越来越长。
应用的并发量太大。
## 常见的分片算法有哪些
分片算法主要解决了数据被水平分片之后，数据究竟该存放在哪个表的问题。
1，哈希分片：求指定 key（比如 id） 的哈希，然后根据哈希值确定数据应被放置在哪个表中。哈希分片比较适合随机读写的场景，不太适合经常需要范围查询的场景。
2，范围分片：按照特性的范围区间（比如时间区间、ID 区间）来分配数据，比如 将 id 为 1~299999 的记录分到第一个库， 300000~599999 的分到第二个库。范围分片适合需要经常进行范围查找的场景，不太适合随机读写的场景（数据未被分散，容易出现热点数据的问题）。
3，地理位置分片：很多 NewSQL 数据库都支持地理位置分片算法，也就是根据地理位置（如城市、地域）来分配数据。
4，融合算法：灵活组合多种分片算法，比如将哈希分片和范围分片组合。……
5，标准分片，自定义分片
## 引入分库分表之后，会给系统带来什么挑战呢
1，join 操作
同一个数据库中的表分布在了不同的数据库中，导致无法使用 join 操作。这样就导致我们需要手动进行数据的封装，比如你在一个数据库中查询到一个数据之后，再根据这个数据去另外一个数据库中找对应的数据。不过，很多大厂的资深 DBA 都是建议尽量不要使用 join 操作。因为 join 的效率低，并且会对分库分表造成影响。对于需要用到 join 操作的地方，可以采用多次查询业务层进行数据组装的方法。不过，这种方法需要考虑业务上多次查询的事务性的容忍度。
2，事务问题：同一个数据库中的表分布在了不同的数据库中，如果单个操作涉及到多个数据库，那么数据库自带的事务就无法满足我们的要求了。这个时候，我们就需要引入分布式事务了。
3，分布式 ID
分库之后， 数据遍布在不同服务器上的数据库，数据库的自增主键已经没办法满足生成的主键唯一了。我们如何为不同的数据节点生成全局唯一主键呢？这个时候，我们就需要为我们的系统引入分布式 ID 了
4，跨库聚合查询问题：分库分表会导致常规聚合查询操作，如 group by，order by 等变得异常复杂。这是因为这些操作需要在多个分片上进行数据汇总和排序，而不是在单个数据库上进行。为了实现这些操作，需要编写复杂的业务代码，或者使用中间件来协调分片间的通信和数据传输。这样会增加开发和维护的成本，以及影响查询的性能和可扩展性。
## 什么是数据冷热分离
数据冷热分离是指根据数据的访问频率和业务重要性，将数据分为冷数据和热数据，冷数据一般存储在存储在低成本、低性能的介质中，热数据高性能存储介质中。
例如：邮件系统中，可以将近期的比较重要的邮件放在收件箱，将比较久远的不太重要的邮件存入归档。


