---
title: CAP&BASE
category:
  - 分布式
order: 1
tag:
  - distributed
  - CAP&BASE
---

## CAP
C consistency 一致性  
A Availability 可用性  
P Partition Tolerance 分区容错性  
CAP 理论就我个人的理解是，如果没有发生网络分区的情况下，要保证 CA，也就是集群的一致性和高可用性，但是如果因为环境等各种原因，导致了分布式系统发生网络分区，只能要么系统保证一致性，要么保证高可用性，要根据实际分布式系统的功能来进行取舍。    

### 什么是网络分区
分布式系统中，多个节点的网络本来是通的，但是因为某些故障，导致节点之间不通了，整个网路就成了几块区域，这就叫网络分区。

### CAP实际案例
注册中心就是CAP的实际应用，例如 Zookeeper，Eureka，Nacos。   
Zookeeper 保证的就是CP，任何时刻对 Zookeeper 的读请求，都能得到一致的结果，但是 Zookeeper 不保证每次请求都是高可用的，比如在 Leader 选举的过程中，半数或者半数以上的机器不可用的时候整个服务都是不可用的。  
Eureka 保证的则是 AP，Eureka 在设计的时候优先保证 A（可用性），在 Eureka 中不存在 Leader 节点，每个节点都是一样的、平等的，因此 Eureka 不会像 Zookeeper 那样出现选举过程中或者半数以上机器不可用的时候服务不可用。  
Eureka 保证即使大部分节点挂掉也不会影响正常提供服务，只要有一个节点可用就行，只不过不保证最新的。  
Nacos 即支持AP也支持CP。  
Redis 集群是 CP 的，不管是主从模式，还是哨兵模式，都是 CP 的。  
Opentp 集群模式是 AP 的。

## BASE 理论
**BASE** 是以下几个单词的缩写。  
**basically availble** 基本可用  
**soft-state** 软状态  
**eventurally consistent** 最终一致性  
它是 CAP 理论演化而来的，它是 AP 理论的延伸。

即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。  
也就是牺牲数据的一致性来满足系统的高可用性，系统中一部分数据不可用或者不一致时，仍需要保持系统整体“主要可用”。  
> AP 方案就是发生网络分区的时候保证高可用，放弃一致性，而 BASE 理论就是在这个基础上，保证在分区故障恢复后，系统应该达到最终一致性。

### 基本可用
基本可用是指分布式系统在出现网络分区的时候，允许损失部分可用性。  
- 响应时间上: 系统功能响应时长增加。
- 系统功能上：部分非核心功能无法使用。

### 软状态
软状态指允许系统中的数据存在中间状态，例如短时间内各节点数据不一致等问题，不影响系统的整体可用性。
> 比如 Eurake 允许各个服务的数据存在短时间不一致，或者某些分布式系统数据同步时允许存在延时。

### 最终一致性
最终一致性顾名思义，就是不强调强一致性，只要求经过一段时间的同步，达到最终一致性。  
最终一致性强调的是系统最终能够达到一个一致的状态。  
最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。  
> 弱一致性：对一致性没有要求，尽量保证某个时刻达到数据一致的状态。分布式系统几乎没有这样要求的。   
> 强一致性：分布式系统内各个服务同一时间读取到的内容必须一致。  
> 最终一致性：弱一致性和强一致的综合版本，系统会保证在一定时间内达到数据一致的状态。  
> 如果不是特别严格的场景，例如转账扣款，订单支付等等，建议保证最终一致性即可。


最终一致的实现方式：  
1. 版本向量（Version Vectors）：
版本向量是一种向量时钟（vector clock）的扩展，用于跟踪数据副本的更新顺序和关系。当数据副本之间发生冲突时，可以使用版本向量来解决冲突并最终达到一致状态。
2. CRDTs（Conflict-free Replicated Data Types）：
CRDTs 是一种数据结构设计模式，用于实现分布式系统中的最终一致性。CRDTs 支持并发更新，无需锁定和中心化协调，能够保证最终状态的一致性。
3. 事件溯源（Event Sourcing）：
事件溯源是一种将系统状态表示为一系列事件序列的模式。通过记录所有事件并将其应用于数据副本，可以实现最终一致性。
4. 消息队列和异步通信：
使用消息队列和异步通信的方式，将数据更新以事件或消息的形式广播到所有副本。虽然存在一定延迟和不一致性，但最终会达到一致状态。
5. 基于日志的复制（Log-based Replication）：
通过在主节点上记录所有的数据更新操作日志，并将日志应用到副本节点上，可以实现最终一致性。
6. 定期数据同步：
定期执行数据同步操作，将数据从一个副本复制到另一个副本，通过定期同步可以逐渐达到数据的一致性。

比较推荐 写时修复，这种方式对性能消耗比较低。




