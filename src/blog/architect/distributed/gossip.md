---
title: Gossip协议
category:
  - 分布式
order: 3
tag:
  - distributed
  - Gossip
---

## 介绍
Gossip协议即谣言协议或者八卦协议。  
具有去中心化、最终一致性、分布式容错等特点。  
在很多开源项目和国外的分布式系统中有很多应用，例如：Amazon S3、Amzon Dynamo、Cassandra、Redis、CockroachDB等等。  
它是一个 AP 模型或者说 BASE 模型的最终一致性协议。  

### Gossip协议理论基础
Gossip 的理论参考社交网络或者瘟疫传播，流言传播。
在社交网络，有个著名的六度分隔理论。1967年，哈佛大学的心理学教授Stanley Milgram想要描绘一个连结人与社区的人际连系网。做过一次连锁信实验，结果发现了“六度分隔”现象。  
简单地说：“你和任何一个陌生人之间所间隔的人不会超过六个，也就是说，最多通过六个人你就能够认识任何一个陌生人。
> 数学解释该理论：若每个人平均认识260人，其六度就是 260^6^ =1,188,137,600,000。消除一些重复，那也几乎覆盖了整个地球人口若干多多倍。   

这也是Gossip协议的雏形。  
  
Gossip协议基本思想就是：一个节点想要分享一些信息给网络中的其他的一些节点。于是它周期性的随机选择一些节点，并把信息传递给这些节点。
这些收到信息的节点接下来会做同样的事情，即把这些信息传递给其他一些随机选择的节点。信息会周期性的传递给N个目标节点，而不只是一个。
> 这个N被称为fanout（扇出）。

## 特性
### 去中心化
Gossip 协议是去中心化的，没有 Leader 节点。任何一个节点无论什么时候下线或者加入，并不会破坏整个系统的服务质量。

### 分布式容错
Gossip 也具备失败容错的能力，即使网络故障等一些问题，Gossip 协议依然能很好的运行。因为一个节点会多次分享某个需要传播的信息，即使不能连通某个节点，其他被感染的节点也会尝试向这个节点传播信息。

### 可扩展性
Gossip协议是可扩展的，任意节点，任意时间都可以加入集群，它只需要 O(logN) 个周期就能把消息传播给所有节点。

### 最终一致
根据上面的描述可以知道，所有节点状态收敛一致需要一段时间，这也是 gossip 被称作最终一致性协议的原因，这段时间的长短与集群中节点的数量成指数级增长，这也是gossip协议最受诟病的地方，但也不是没有没方案解决。Amazon S3单集群在全球的部数量达到 10+w 台物理机通过 gossip 协议管理节点就是例证，在Redis常见集群架构中会尝试提出一种解决方案。

## 传播模式
1. 反熵
> 反熵，指消除不同节点中数据差异，通过向其他节点同步自己的所有信息，来消除两者之间的差异，提高数据一致性，从而实现最终一致性。

2. 传谣
> 谣言传播指的是在分布式系统中某个节点有了新数据，就会开始周期性的向其他节点发送新数据，直到所有节点都存储了该数据。

## 传播方式
### Push模式
节点A将全部数据推送到节点B，B更新比节点A陈旧的数据，Push完成后，A数据保持不变，B被A感染;  
需要1个通信周期
### Pull模式
节点A发送摘要数据(即数据版本)到节点B，B将本地比A新的数据发送到A，A更新 本地数据;  
Pull完成后，B数据保持不变，A被B感染;  
需要2个通信周期
### Push-Pull模式
A将摘要数据发送到B，B将本地更新的数据发送到A，同时，B将本地比A老的数据生成摘要也发送给A，A更新本地数据，同时将A中更新的数据发送给B，B更新本地数据;    
Push-Pull完成后，A/B数据都有更新，交叉感染;    
需要3个通信周期  


**Push-Pull模式的收敛速度最快， Pull模式次之，Push模式最慢。**

## 代码示例
我的开源项目[opentp](https://github.com/zhanggongX/open-tp),就是基于 AP 或者说 BASE 架构的，集群部署时，各个节点信息同步，就是基于 Gossip 协议。   

一句话总结就是：基于 Netty 实现的 UDP 通信、PUSH-PULL 传播方法、反熵模式的 Gossip 协议。
[协议代码传送门](https://github.com/zhanggongX/open-tp/tree/master/opentp-gossip)
